name: Deploy to Staging - stage.mustaheq.org

on:
  push:
    branches:
      - staging # Push to 'staging' branch triggers this workflow

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DEPLOY_DIR: "/var/www/staging"
      TIMESTAMP: ${{ github.run_id }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install

      - name: Build React App
        run: npm run build

      - name: Write SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGE_SSH_KEY }}" > ~/.ssh/stage_deploy_key
          chmod 600 ~/.ssh/stage_deploy_key

      - name: Backup Current Staging Deployment
        run: |
          ssh -i ~/.ssh/stage_deploy_key -o StrictHostKeyChecking=no git@${{ secrets.STAGE_SERVER_HOST }} \
          "cp -r $DEPLOY_DIR ${DEPLOY_DIR}_backup_${TIMESTAMP}"
        continue-on-error: false

      - name: Deploy Build to Staging Server
        id: deploy
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGE_SERVER_HOST }}
          username: git
          key: ${{ secrets.STAGE_SSH_KEY }}
          source: "build/*"
          target: "/var/www/staging"
          strip_components: 1
        continue-on-error: true

      - name: Rollback if Deploy Fails
        if: steps.deploy.outcome != 'success'
        run: |
          echo "Staging deployment failed — rolling back..."
          ssh -i ~/.ssh/stage_deploy_key -o StrictHostKeyChecking=no git@${{ secrets.STAGE_SERVER_HOST }} \
          "latest_backup=\$(ls -td ${DEPLOY_DIR}_backup_* | head -n 1) && \
          rm -rf $DEPLOY_DIR && cp -r \$latest_backup $DEPLOY_DIR && echo 'Rollback complete ✅'"

      - name: Clean Old Backups (Optional)
        run: |
          ssh -i ~/.ssh/stage_deploy_key -o StrictHostKeyChecking=no git@${{ secrets.STAGE_SERVER_HOST }} \
          "find /var/www -maxdepth 1 -name 'staging_backup_*' -mtime +7 -exec rm -rf {} \;"
