name: Deploy to Staging - stage.mustaheq.org

on:
  push:
    branches:
      - staging # Push to 'staging' branch triggers this workflow

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DEPLOY_DIR: "/var/www/staging"
      TIMESTAMP: ${{ github.run_id }}

    steps:
      - name: Bump version based on last PR title
        id: bump
        run: |
          VERSION_FILE="src/documentation/version.ts"
          CURRENT_VERSION=$(grep -oP '[0-9]+\.[0-9]+\.[0-9]+' $VERSION_FILE)
          BASE=$(echo $CURRENT_VERSION | cut -d. -f1,2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)

          echo "Current Version: $CURRENT_VERSION"

          # Get last merged PR title
          PR_TITLE=$(gh pr list --state merged --base stg --sort merged --limit 1 --json title --jq '.[0].title')
          echo "Last PR Title: $PR_TITLE"

          # Decide bump type
          if [[ "$PR_TITLE" =~ ^(Fix|Enhance): ]]; then
            PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          elif [[ "$PR_TITLE" =~ ^Build: ]]; then
            MINOR=$((MINOR + 1))
            NEW_VERSION="$MAJOR.$MINOR.0"
          elif [[ "$PR_TITLE" =~ ^Upgrade: ]]; then
            MAJOR=$((MAJOR + 1))
            NEW_VERSION="$MAJOR.0.0"
          else
            echo "No bump. Title doesn't match Fix:, Enhance:, Build:", or Upgrade:
            exit 0
          fi

          echo "export const APP_VERSION = \"$NEW_VERSION\";" > $VERSION_FILE
          echo "ðŸ”¢ Bumped version to $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push version bump
        if: steps.bump.outputs.new_version != ''
        run: |
          git config user.name "Makkahwi Bot"
          git config user.email "SuhaibAhmadAi@hotmail.com"
          git add src/documentation/version.ts
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }} [ci skip]" || echo "Nothing to commit"
          git push origin stg

      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install

      - name: Build React App
        run: npm run build

      - name: Write SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGE_SSH_KEY }}" > ~/.ssh/stage_deploy_key
          chmod 600 ~/.ssh/stage_deploy_key

      - name: Backup Current Staging Deployment
        run: |
          ssh -i ~/.ssh/stage_deploy_key -o StrictHostKeyChecking=no git@${{ secrets.STAGE_SERVER_HOST }} \
          "cp -r $DEPLOY_DIR ${DEPLOY_DIR}_backup_${TIMESTAMP}"
        continue-on-error: false

      - name: Deploy Build to Staging Server
        id: deploy
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGE_SERVER_HOST }}
          username: git
          key: ${{ secrets.STAGE_SSH_KEY }}
          source: "build/*"
          target: "/var/www/staging"
          strip_components: 1
        continue-on-error: true

      - name: Rollback if Deploy Fails
        if: steps.deploy.outcome != 'success'
        run: |
          echo "Staging deployment failed â€” rolling back..."
          ssh -i ~/.ssh/stage_deploy_key -o StrictHostKeyChecking=no git@${{ secrets.STAGE_SERVER_HOST }} \
          "latest_backup=\$(ls -td ${DEPLOY_DIR}_backup_* | head -n 1) && \
          rm -rf $DEPLOY_DIR && cp -r \$latest_backup $DEPLOY_DIR && echo 'Rollback complete âœ…'"

      - name: Clean Old Backups (Optional)
        run: |
          ssh -i ~/.ssh/stage_deploy_key -o StrictHostKeyChecking=no git@${{ secrets.STAGE_SERVER_HOST }} \
          "find /var/www -maxdepth 1 -name 'staging_backup_*' -mtime +7 -exec rm -rf {} \;"
