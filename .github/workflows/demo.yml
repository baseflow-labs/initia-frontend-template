name: ðŸš€ Deploy and Debug Demo Server
run-name: ðŸš€ Demo Deploy - ${{ github.actor }} on ${{ github.ref_name }}

concurrency:
  group: demo-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_run:
    workflows: ["ðŸ·ï¸ Version Bump and Tag Creation"]
    types:
      - completed
    branches:
      - prod
  workflow_dispatch:
  
jobs:  
  deployment:
    name: Demo Deployment
    runs-on: ubuntu-latest
    environment: demo
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/demo.key
          chmod 600 ~/.ssh/demo.key

          cat >>~/.ssh/config <<END
          Host demo
            HostName $SSH_SERVER
            User $SSH_USER
            IdentityFile ~/.ssh/demo.key
            StrictHostKeyChecking no
          END
        env:
          SSH_USER: ${{ secrets.DEMO_SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_SERVER: ${{ secrets.DEMO_SSH_SERVER }}

      - name: Deploy to demo
        run: |
          ssh -tt demo << 'EOF'
          set -e
          echo "ðŸ” Connected to demo machine"

          cd ${{ secrets.DEMO_APP_DIR }}

          echo "ðŸ“¥ Pulling latest code..."
          GIT_SSH_COMMAND="ssh -i ${{ secrets.DEMO_PULL_KEY_PATH }}" git pull

          echo "ðŸ³ Building and restarting fe with optimizations"

          cd ${{ secrets.DEMO_DOCKER_COMPOSE_DIR }}
          for dir in */; do
            cd ${{ secrets.DEMO_DOCKER_COMPOSE_DIR }}/$dir
            set +x
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            docker compose build --memory=1g "fe"
            docker compose up -d "fe"
            set -x
            echo "âœ… Deployment complete for $dir"
          done

          set +e
          exit 0
          EOF
