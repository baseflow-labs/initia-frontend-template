name: ðŸš€ Deploy Production Server

concurrency:
  group: production-deploy-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_run:
    workflows: ["ðŸ·ï¸ Version Bump and Tag Creation"]
    types:
      - completed
    branches:
      - prod

jobs:
  deployment:
    name: Production Deployment
    runs-on: ubuntu-latest
    environment: production
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/production.key
          chmod 600 ~/.ssh/production.key

          cat >>~/.ssh/config <<END
          Host production
            HostName $SSH_SERVER
            User $SSH_USER
            IdentityFile ~/.ssh/production.key
            StrictHostKeyChecking no
          END
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_SERVER: ${{ secrets.SSH_SERVER }}

      - name: Deploy to production
        run: |
          ssh -tt production << 'EOF'
          set -e
          echo "ðŸ” Connected to production machine"

          cd ${{ secrets.APP_DIR }}

          echo "ðŸ“¥ Pulling latest code..."
          GIT_SSH_COMMAND="ssh -i ${{ secrets.PULL_KEY_PATH }}" git pull

          echo "ðŸ³ Building and restarting fe with optimizations"

          cd ${{ secrets.DOCKER_COMPOSE_DIR }}
          for dir in */; do
            cd ${{ secrets.DOCKER_COMPOSE_DIR }}/$dir
            set +x
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            docker compose build --memory=1g "fe"
            docker compose up -d "fe"
            set -x
            echo "âœ… Deployment complete for $dir"
          done

          set +e
          exit 0
          EOF
